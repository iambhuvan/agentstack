name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  backend-tests:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest when tests exist
        shell: bash
        run: |
          if [ -d tests ] || find . -maxdepth 3 -type f \( -name "test_*.py" -o -name "*_test.py" \) | grep -q .; then
            pytest -q
          else
            echo "No backend tests found, skipping pytest."
          fi

  sdk-python-tests:
    name: Python SDK Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdk/python
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package + dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest when tests exist
        shell: bash
        run: |
          if [ -d tests ] || find . -maxdepth 3 -type f \( -name "test_*.py" -o -name "*_test.py" \) | grep -q .; then
            pytest -q
          else
            echo "No sdk/python tests found, skipping pytest."
          fi

  node-checks:
    name: Node Checks (${{ matrix.project }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: cli
            dir: cli
            check_command: npm run build
          - project: mcp
            dir: mcp
            check_command: npm run build
          - project: sdk-typescript
            dir: sdk/typescript
            check_command: npm run build
          - project: dashboard
            dir: dashboard
            check_command: npm run lint && npm run build
    defaults:
      run:
        working-directory: ${{ matrix.dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.dir }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run checks
        run: ${{ matrix.check_command }}

  docs-checks:
    name: Docs Build (VitePress)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build docs
        run: npm run docs:build

  deploy-render:
    name: Deploy (Render)
    runs-on: ubuntu-latest
    needs:
      - sdk-python-tests
      - node-checks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      RENDER_API_DEPLOY_HOOK: ${{ secrets.RENDER_API_DEPLOY_HOOK }}
      RENDER_DASHBOARD_DEPLOY_HOOK: ${{ secrets.RENDER_DASHBOARD_DEPLOY_HOOK }}
    steps:
      - name: Trigger API deploy hook
        if: ${{ env.RENDER_API_DEPLOY_HOOK != '' }}
        run: curl -fsSL -X POST "$RENDER_API_DEPLOY_HOOK"

      - name: Trigger Dashboard deploy hook
        if: ${{ env.RENDER_DASHBOARD_DEPLOY_HOOK != '' }}
        run: curl -fsSL -X POST "$RENDER_DASHBOARD_DEPLOY_HOOK"

      - name: Skip when no deploy hooks are configured
        if: ${{ env.RENDER_API_DEPLOY_HOOK == '' && env.RENDER_DASHBOARD_DEPLOY_HOOK == '' }}
        run: echo "No Render deploy hooks configured. Skipping deployment."

  deploy-docs:
    name: Deploy Docs (GitHub Pages)
    runs-on: ubuntu-latest
    needs:
      - docs-checks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        working-directory: docs
        run: npm ci

      - name: Build docs
        working-directory: docs
        run: npm run docs:build

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
